---
title: '**MyFirstRMarkdowndocument**'
author: "B199291"
date: "`r format (Sys.time (), '%d %B, %Y')`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
#Loading NHSRdatasets and required packages.
```{r a,message = FALSE, warning = FALSE}
library(NHSRdatasets)
library(tidyverse)
library(here)
library(knitr)
library(scales)
library(lubridate)
library(caret)
```

#Loading ae_attendances Dataset
```{r b,message = FALSE, warning = FALSE}
#Load the ae_attendances data.
data(ae_attendances)
```


## Letâ€™s have a look at the ae_attendances data
```{r c,message = FALSE, warning = FALSE}
ae<-ae_attendances
class(ae)
glimpse(ae)
```
I looked the ae_attedances data review and its class using class function and glimpse function from tidyverse. The data frame has 12,765 rows of data and six columns of different variables with different classes. I can see period (date variable), org_code and type (factor variable), attendances, breaches and admissions as numerice(double precision)variables. As per my intention, I will use type(factor) variable to subset into new data set.

## Missing data checking
```{r n,message = FALSE, warning = FALSE}
ae %>% 
  map(is.na) %>%
map(sum)
```
Just to make sure that there is no missing data in the table and the data is complete.
## Let's add an index link column to ae_attendances data  
For DCT development and training and testing dataset separation, i will add index ref column.
```{r o,message = FALSE, warning = FALSE}
ae <- rowid_to_column(ae, "index")
```

## Let's tablulate the raw data for your report
The pipe operator denoted by symbol `%>%` is a special operational function available which allows us to pass the result of one function/argument to the other one in sequence.
The the *dplyr* package `mutate_at()` function edits specific columns with a character vector or 'vars()' argument generates a list of columns. The function `comma()` from the *scales* package is useful for presenting numbers using commas to separate the thousands. This is always a good idea as it assists the reader in quickly determining the magnitude of the numbers we are looking at. As a matter of course, I recommend commas in plots (and tables) at all times. 
```{r p,message = FALSE, warning = FALSE}
ae %>%
  # Set the period column to show in month-year format
  mutate_at(vars(period), format, "%b-%y") %>% 
  # Set the numeric columns to have a comma at the 1000's place
  mutate_at(vars(attendances, breaches, admissions), comma) %>%
  # Show the first 10 rows
  head(10) %>%
  # Format as a table
  kable()
```

## Let's save the raw ae_attendances data to your 'RawData' folder
We will use the *here* package to build a path relative to the top-level directory to write the raw ae_attendances data to your 'RawData' folder. The goal of the *here* package is to enable easy file referencing in project-oriented workflows. In contrast to using `setwd()` function, which is fragile and dependent on the way you organise your files, here uses the top-level directory of a project to easily build paths to files.
![Illustration by [Allison Horst](https://github.com/allisonhorst)](../Figures/Images/here.png){width=50%}
```{r q,message = FALSE, warning = FALSE}
write_csv(ae, here("RefData", "ae_attendances.csv"))
```




# **Selecting variables for your data capture tool**
It really important point to note, is that you are not going to need the full ae_attendances dataset develop your data collection tool. For example if you are interested in exploring four hours performance for England as a whole you will only need the variables: index, period, attendances, breaches. Likewise, you may wish examine performance for the different types of department, we would also need the type variable. For the purpose of this lesson, we will focus on  England as a whole.

## Examining the four-hour waiting time target performance for England

We will now use the *dplyr* package `select()` function to select the required variables. The *dplyr* package is loaded by the *tidyverse* package, as one of its core components. dplyr provides a grammar of data manipulation, providing a consistent set of verbs that solve the most common data manipulation challenges.

```{r r,message = FALSE, warning = FALSE}
ae<-ae %>% select(index, period, attendances, breaches)
```
### Let's tabulate the subsetted ae_attendances data
```{r s,message = FALSE, warning = FALSE}
ae %>%
  # set the period column to show in Month-Year format
  mutate_at(vars(period), format, "%b-%y") %>% 
  # set the numeric columns to have a comma at the 1000's place
  mutate_at(vars(attendances, breaches), comma) %>%
  # show the first 10 rows
  head(10) %>%
  # format as a table
  kable()
```


# Let's calculate monthly four hour waiting time target performance for England as a whole
We will now use the *dplyr* package `summarise_at()` function to get the `sum` of all attendances and breaches for England as a whole.
```{r t,message = FALSE, warning = FALSE}
ENG_performance <- ae %>%
  group_by(period) %>%
  summarise_at(vars(attendances, breaches), sum) %>%
  mutate(performance = 1 - breaches / attendances)
glimpse(ENG_performance)
```

### Let's visualise monthly four hour waiting time target performance before we save or raw data file.
*ggplot2* is a powerful package to draw graphics. It implements the grammar of graphics (and hence its name). The *ggplot2* package is loaded by the *tidyverse* package, as one of its core components. The `ggplot()` function initialises a *ggplot* object. We will use the `geom_line()` to connect and geom_point() to represent the percentage of accident and emergency attendances that met the four hour standard (`y`), ordered by month of attendance(`x`). We will use the `labs()` function to add the `x` and `y` labels, plot title and caption.
```{r u,message = FALSE, warning = FALSE}
ggplot(ENG_performance, aes(period, performance)) +
  geom_line(color = "darkcyan") +
  geom_point(color = "darkcyan") +
  scale_y_continuous(labels = percent) +
  scale_x_date(date_labels = "%b-%y", date_breaks = "11 month")+
  labs(x = "Month of attendance",
       y = "% of A&E attendances that met the four hour standard",
       title = "NHS England accident and emergency (A&E) four hour performance",
       caption = "Source: NHSRdatasets")
```

The National Health Service (NHS) is always under considerable pressure over the winter period as demand for services tends to increase significantly with the onset of cold weather and flu.([ NHS Providers, 2022](https://eu01.alma.exlibrisgroup.com/leganto/public/44UOE_INST/citation/37470286210002466?auth=SAML)) You can clearly see that under the winter pressures  where four hour waiting time target performance drops.


## Let's select the ae_attendances data subset for further exploratory analysis
Based on this brief probe of the of the ae_attendances data, we have decide we wish to explore this data further for the development and evaluation your data capture tool. 

### Let's tabulate the subsetted ae_attendances data for your report
```{r v,message = FALSE, warning = FALSE}
ae %>%
  # set the period column to show in Month-Year format
  mutate_at(vars(period), format, "%b-%y") %>% 
  # set the numeric columns to have a comma at the 1000's place
  mutate_at(vars(attendances, breaches), comma) %>%
  # show the first 10 rows
  head(10) %>%
  # format as a table
  kable()
```

### Let's save provisional subsetted ae_attendances data to the 'RawData' folder
Of note, when naming folders and files, it is important that you do so in a consistent, logical and predictable way means that information may be located, identified and retrieved by your and your colleagues, as quickly and easily as possible. With this in mind let's name this file "ae_attendances_ENG_4hr_perfom", and write it to the raw data folder.
```{r w,message = FALSE, warning = FALSE}
glimpse(ae)
write_csv(ae, here("RawData", "ae_attendances_ENG_4hr_perfom.csv"))
```

## Separating provisional ae_attendances_ENG_4hr_perfom data into training and testing sets
To develop and evaluate your data capture tool, you will need to splint the raw data into test and training data sets.
We have added an index column earlier, so we can link the partitioned data sets to the raw ae_attendances and ae_attendances_ENG_4hr_perfom if required in the future. 


### How many rows are in the ae_attendances_ENG_4hr_perfom dataset?
```{r x,message = FALSE, warning = FALSE}
#The ae_attendances_ENG_4hr_perfom dataset is large with 
nrow(ae) #rows of data
```

We do not want you to spend hours inputting rows and rows of data into your data capture tool. A test data set of 10-15 records to capture with and evaluate your data capture tool is sufficient for the purpose of the course assignment. Here is how to work out the proportion (`prop`) of the raw data to assign to the training data:
```{r y,message = FALSE, warning = FALSE}
prop<-(1-(15/nrow(ae)))
#The proportion of the raw that needs to be assigned to the training data to ensure there is only 10 to 15 records in the test data is: 
print(prop)
```
We will use the createDataPartition() function from the *caret* package to splint our raw data into test and training data sets.
The 'set.seed()' function is a random number generator, which is useful for creating random objects that can be reproduced. This will make sure that every time we run this script, we will partition the raw data into the same test and training data.
```{r z,message = FALSE, warning = FALSE}
set.seed(333)
#Partitioning the raw data into the test and training data.
trainIndex <- createDataPartition(ae$index, p = prop, 
                                  list = FALSE, 
                                  times = 1)
head(trainIndex)
# All records that are in the trainIndex are assigned to the training data.
aeTrain <- ae[ trainIndex,]
nrow(aeTrain)
```
There are 12,753 records in your training data. That is a large dataset!

### Let's tabulate ae_attendances_ENG_4hr_perfom training data for your report
```{r aa,message = FALSE, warning = FALSE}
aeTrain %>%
  # set the period column to show in Month-Year format
  mutate_at(vars(period), format, "%b-%y") %>% 
  # set the numeric columns to have a comma at the 1000's place
  mutate_at(vars(attendances, breaches), comma) %>%
  # show the first 10 rows
  head(10) %>%
  # format as a table
  kable()
  ```
  
### Our next task, it to save ae_attendances_ENG_4hr_perfom training data to your working data folder 'Data'
```{r ab,message = FALSE, warning = FALSE}
write_csv(aeTrain, here("Data", "ae_attendances_ENG_4hr_perfom_train.csv"))
```

### Let's extract the ae_attendances_ENG_4hr_perfom test data
#All records that are not in the trainIndex (`-trainIndex`) are assigned to the test data.
```{r ac,message = FALSE, warning = FALSE}
aeTest  <- ae[-trainIndex,]
nrow(aeTest)
```
There are 12 records in your test data. Perfect! You now need to set aside the first record from the ae_attendances_ENG_4hr_perfom test data so that your markers can test and evaluate your data-capture tool.
```{r ad,message = FALSE, warning = FALSE}
aeTestMarker  <- aeTest[1,]
```
#### Let's tabulate ae_attendances_ENG_4hr_perfom marker test data for your report
```{r ae,message = FALSE, warning = FALSE}
aeTestMarker  %>%
  # set the period column to show in Month-Year format
  mutate_at(vars(period), format, "%b-%y") %>% 
  # set the numeric columns to have a comma at the 1000's place
  mutate_at(vars(attendances, breaches), comma) %>%
  # show the first 10 rows
  head(10) %>%
  # format as a table
  kable()
```
### Our next task, it to save our ae_attendances_ENG_4hr_perfom marker test data to our working data folder 'Data'
```{r af,message = FALSE, warning = FALSE}
write_csv(aeTestMarker, here("Data", "ae_attendances_ENG_4hr_perfom_test_marker.csv"))
```

### We then need to set aside the remaining records for you to test (or collect with your) your data-capture tool.
```{r ag,message = FALSE, warning = FALSE}
aeTest  <- aeTest[2:nrow(aeTest),]
```
#### Let's tabulate ae_attendances_ENG_4hr_perfom test data for your report
```{r ah,message = FALSE, warning = FALSE}
aeTest  %>%
  # set the period column to show in Month-Year format
  mutate_at(vars(period), format, "%b-%y") %>% 
  # set the numeric columns to have a comma at the 1000's place
  mutate_at(vars(attendances, breaches), comma) %>%
  # show the first 10 rows
  head(10) %>%
  # format as a table
  kable()
```

### Our final task, is to save our ae_attendances_ENG_4hr_perfom test data to our working data folder 'Data'
```{r ai,message = FALSE, warning = FALSE}
write_csv(aeTest, here("Data", "ae_attendances_test.csv"))
```


You are now ready to start exploring your data. Happy coding!


